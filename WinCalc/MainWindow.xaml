<Window x:Class="WinCalc.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        Title="WinCalc" Height="700" Width="1100"
        MinHeight="700" MinWidth="1100"
        MaxHeight="900" MaxWidth="1600">

    <!-- Стабільне джерело для ComboBox Ролей -->
    <Window.Resources>
        <x:Array x:Key="RolesList" Type="{x:Type sys:String}">
            <sys:String>admin</sys:String>
            <sys:String>manager</sys:String>
        </x:Array>
    </Window.Resources>

    <Grid>
        <TabControl Margin="10">

            <!-- ======================= Вкладка: Розрахунок ======================= -->
            <TabItem Header="Розрахунок">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="82"/>
                        <ColumnDefinition Width="138"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Ліва панель: список зображень -->
                    <ListBox x:Name="lstImages"
                             Grid.Column="0"
                             Margin="0,0,10,0"
                             SelectionChanged="lstImages_SelectionChanged"
                             Grid.ColumnSpan="2">
                        <ListBoxItem>
                            <Image Source="/WinCalc;component/Image/5.png" Height="100" Tag="5"/>
                        </ListBoxItem>
                        <ListBoxItem>
                            <Image Source="/WinCalc;component/Image/4.png" Height="100" Tag="4"/>
                        </ListBoxItem>
                        <ListBoxItem>
                            <Image Source="/WinCalc;component/Image/3.png" Height="100" Tag="3"/>
                        </ListBoxItem>
                        <ListBoxItem>
                            <Image Source="/WinCalc;component/Image/2.png" Height="100" Tag="2"/>
                        </ListBoxItem>
                        <ListBoxItem>
                            <Image Source="/WinCalc;component/Image/7.png" Height="100" Tag="1"/>
                        </ListBoxItem>
                    </ListBox>

                    <!-- Права половина: панель параметрів -->
                    <StackPanel Grid.Column="2" Margin="410,10,10,160">
                        <TextBlock Text="Розрахунок вікна"
                                   FontSize="24"
                                   FontWeight="Bold"
                                   HorizontalAlignment="Center"
                                   Margin="0,0,0,10"/>

                        <!-- Ширина / Висота -->
                        <StackPanel Orientation="Horizontal"
                                    HorizontalAlignment="Center"
                                    Margin="0,5">
                            <Label Content="Ширина:" VerticalAlignment="Center"/>
                            <TextBox x:Name="txtWidth" Width="120" Margin="5,0"/>
                            <Label Content="Висота:" VerticalAlignment="Center" Margin="20,0,0,0"/>
                            <TextBox x:Name="txtHeight" Width="120" Margin="5,0"/>
                        </StackPanel>

                        <!-- Параметри -->
                        <StackPanel Margin="0,10"
                                    HorizontalAlignment="Center"
                                    Width="380">
                            <Label Content="Обрана конструкція"/>
                            <ComboBox x:Name="cmbWindowType" Width="380"/>

                            <Label Content="Бренд" Margin="0,5,0,0"/>
                            <ComboBox x:Name="cmbBrand" Width="380" SelectionChanged="cmbBrand_SelectionChanged"/>

                            <Label Content="Профіль" Margin="0,5,0,0"/>
                            <ComboBox x:Name="cmbProfile" Width="380"/>

                            <Label Content="Склопакет" Margin="0,5,0,0"/>
                            <ComboBox x:Name="cmbGlassPack" Width="380"/>
                        </StackPanel>

                        <!-- Чекбокси -->
                        <StackPanel Orientation="Horizontal"
                                    HorizontalAlignment="Center"
                                    Margin="0,10,0,0">
                            <CheckBox x:Name="chkSill"  Content="Підвіконник" Margin="10,0"/>
                            <CheckBox x:Name="chkDrain" Content="Відлив"      Margin="10,0"/>
                        </StackPanel>
                    </StackPanel>

                    <!-- Головне зображення -->
                    <Border x:Name="borderWithImage"
                            Grid.Column="2"
                            BorderBrush="Black"
                            BorderThickness="1"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Top"
                            Width="390"
                            Height="390"
                            Margin="10,10,0,0">
                        <Image x:Name="imgSelected" Stretch="Uniform"/>
                    </Border>

                    <!-- Результат -->
                    <Label x:Name="lblResult"
                           Grid.Column="2"
                           Content="Розрахуно за вибраними параметрами: --- (вартість без встановлення) ---"
                           FontSize="14"
                           Margin="0,476,0,0"
                           HorizontalAlignment="Center"/>

                    <!-- Кнопка розрахунку -->
                    <Button x:Name="btnCalculate"
                            Grid.Column="2"
                            Content="Розрахувати вартість"
                            Height="36"
                            HorizontalAlignment="Right"
                            Width="360"
                            Margin="0,0,10,15"
                            VerticalAlignment="Bottom"
                            Click="btnCalculate_Click"/>
                </Grid>
            </TabItem>

            <!-- ======================= Вкладка: Матеріали ======================= -->
            <TabItem Header="Матеріали">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                   
                    <DataGrid x:Name="dgMaterials"
                              AutoGenerateColumns="False"
                              Margin="10"
                              Grid.Row="0"
                              CellEditEnding="dgMaterials_CellEditEnding"
                              PreparingCellForEdit="dgMaterials_PreparingCellForEdit"
                              PreviewKeyDown="dgMaterials_PreviewKeyDown">
                        <DataGrid.Columns>
                            <!-- Категорія -->
                            <DataGridTemplateColumn Header="Категорія" Width="140">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Category}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <ComboBox
                                            ItemsSource="{Binding DataContext.MaterialCategories, RelativeSource={RelativeSource AncestorType=Window}}"
                                            Text="{Binding Category, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                            IsEditable="{Binding DataContext.LookupEditMode, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>

                            <!-- Назва -->
                            <DataGridTemplateColumn Header="Назва" Width="180">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <ComboBox
                                            ItemsSource="{Binding DataContext.MaterialNames, RelativeSource={RelativeSource AncestorType=Window}}"
                                            Text="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                            IsEditable="{Binding DataContext.LookupEditMode, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>

                            <!-- Одиниці -->
                            <DataGridTemplateColumn Header="Одиниця" Width="110">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Unit}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                <DataGridTemplateColumn.CellEditingTemplate>
                                    <DataTemplate>
                                        <ComboBox
                                            ItemsSource="{Binding DataContext.Units, RelativeSource={RelativeSource AncestorType=Window}}"
                                            Text="{Binding Unit, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                            IsEditable="{Binding DataContext.LookupEditMode, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellEditingTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTextColumn Header="Ціна" Binding="{Binding Price}" Width="110"/>
                            <DataGridTextColumn Header="Кількість" Binding="{Binding Quantity}" Width="110"/>
                            <DataGridTextColumn Header="Валюта" Binding="{Binding Currency}" Width="90"/>
                            <DataGridTextColumn Header="Опис" Binding="{Binding Description}" Width="260"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Кнопки -->
                    <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="10">
                        <Button Content="Імпорт CSV"   Click="btnImportCsv_Click"   Margin="5,0"/>
                        <Button Content="Експорт CSV"  Click="btnExportCsv_Click"  Margin="5,0"/>
                        <Button Content="Видалити вибрані" Click="btnDeleteMaterial_Click" Margin="5,0"/>
                        <Button Content="Редагувати довідники…" Click="btnToggleLookupEdit_Click" Margin="5,0"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- ======================= Вкладка: Користувачі ======================= -->
            <TabItem Header="Користувачі" Tag="AdminOnly">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <DataGrid x:Name="dgUsers"
                              Grid.Row="0"
                              AutoGenerateColumns="False"
                              CanUserSortColumns="True"
                              Margin="10"
                              RowEditEnding="dgUsers_RowEditEnding">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="60" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Логін" Binding="{Binding Username, UpdateSourceTrigger=PropertyChanged}" Width="160"/>
                            <DataGridComboBoxColumn Header="Роль"
                                                    ItemsSource="{StaticResource RolesList}"
                                                    SelectedItemBinding="{Binding Role, UpdateSourceTrigger=PropertyChanged}"
                                                    Width="120"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <StackPanel Grid.Row="1"
                                Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                Margin="10">
                        <Button Content="Змінити пароль" Click="btnChangePassword_Click" Margin="5,0"/>
                        <Button Content="Видалити вибраних" Click="btnDeleteUser_Click" Margin="5,0"/>
                    </StackPanel>
                </Grid>
            </TabItem>

        </TabControl>
    </Grid>
</Window>
